openapi: 3.1.0
info:
  title: LangDAG API
  description: |
    REST API for managing LLM conversations as node trees.

    Everything is a node. A root node (parent_id = null) defines a conversation tree.
    Prompting from any node creates a child, enabling natural branching and exploration.

    ## Streaming

    Prompt endpoints support real-time streaming via SSE. Set `stream: true` in the request body
    to receive incremental responses as they're generated.

    SSE events:
    - `start` - Stream started
    - `delta` - Incremental content chunk
    - `done` - Stream complete, includes `node_id`
    - `error` - Error occurred

    ## IDs

    All IDs are UUIDs. For convenience, partial ID prefixes are accepted (minimum 4 characters).
  version: 2.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development server

security:
  - ApiKeyAuth: []
  - BearerAuth: []

tags:
  - name: health
    description: Health check endpoints
  - name: prompt
    description: Prompt endpoints for starting and continuing conversations
  - name: nodes
    description: Node management
  - name: workflows
    description: Workflow templates

paths:
  /health:
    get:
      tags: [health]
      summary: Health check
      description: Returns server health status
      security: []
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /prompt:
    post:
      tags: [prompt]
      summary: Start new conversation tree
      description: |
        Creates a new conversation tree by sending a message. Returns the assistant's response node.

        Set `stream: true` to receive the response as SSE.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PromptRequest'
      responses:
        '200':
          description: Prompt response (non-streaming) or SSE stream
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptResponse'
            text/event-stream:
              schema:
                $ref: '#/components/schemas/SSEStream'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /nodes/{id}/prompt:
    post:
      tags: [prompt]
      summary: Continue from existing node
      description: |
        Continues a conversation from an existing node by adding a new message.
        This creates a child branch from the specified node.

        Set `stream: true` to receive the response as SSE.
      parameters:
        - name: id
          in: path
          required: true
          description: Node ID (full or prefix)
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodePromptRequest'
      responses:
        '200':
          description: Prompt response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptResponse'
            text/event-stream:
              schema:
                $ref: '#/components/schemas/SSEStream'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /nodes:
    get:
      tags: [nodes]
      summary: List root nodes
      description: Returns all root nodes (conversations). Root nodes have no parent.
      responses:
        '200':
          description: List of root nodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Node'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /nodes/{id}:
    get:
      tags: [nodes]
      summary: Get a single node
      description: Returns a single node by ID
      parameters:
        - name: id
          in: path
          required: true
          description: Node ID (full or prefix)
          schema:
            type: string
      responses:
        '200':
          description: Node details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      tags: [nodes]
      summary: Delete node and subtree
      description: Deletes a node and all its descendants
      parameters:
        - name: id
          in: path
          required: true
          description: Node ID (full or prefix)
          schema:
            type: string
      responses:
        '200':
          description: Node deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: deleted
                  id:
                    type: string
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /nodes/{id}/tree:
    get:
      tags: [nodes]
      summary: Get full tree from node
      description: Returns the node and all its descendants as a flat array
      parameters:
        - name: id
          in: path
          required: true
          description: Node ID (full or prefix)
          schema:
            type: string
      responses:
        '200':
          description: Array of nodes in the subtree
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Node'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /workflows:
    get:
      tags: [workflows]
      summary: List workflows
      description: Returns all workflow templates
      responses:
        '200':
          description: List of workflows
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Workflow'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [workflows]
      summary: Create workflow
      description: Creates a new workflow template
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkflowRequest'
      responses:
        '201':
          description: Workflow created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /workflows/{id}/run:
    post:
      tags: [workflows]
      summary: Run workflow
      description: Executes a workflow template
      parameters:
        - name: id
          in: path
          required: true
          description: Workflow ID or name
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunWorkflowRequest'
      responses:
        '200':
          description: Workflow run result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunWorkflowResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication
    BearerAuth:
      type: http
      scheme: bearer
      description: Bearer token authentication

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
      required:
        - error

    Node:
      type: object
      properties:
        id:
          type: string
          format: uuid
        parent_id:
          type: string
          format: uuid
          description: Parent node ID (null for root nodes)
        sequence:
          type: integer
          description: Node sequence number
        node_type:
          type: string
          enum: [user, assistant, system, tool_call, tool_result]
        content:
          type: string
          description: Node content (message text)
        model:
          type: string
          description: LLM model used (on assistant nodes)
        tokens_in:
          type: integer
        tokens_out:
          type: integer
        latency_ms:
          type: integer
        status:
          type: string
        title:
          type: string
          description: Conversation title (on root nodes only)
        system_prompt:
          type: string
          description: System prompt (on root nodes only)
        created_at:
          type: string
          format: date-time
      required:
        - id
        - sequence
        - node_type
        - content
        - created_at

    PromptRequest:
      type: object
      properties:
        message:
          type: string
          description: Message to send
        model:
          type: string
          default: claude-sonnet-4-20250514
          description: LLM model to use
        system_prompt:
          type: string
          description: Optional system prompt (only for new conversations)
        stream:
          type: boolean
          default: false
          description: Enable SSE streaming
      required:
        - message

    NodePromptRequest:
      type: object
      properties:
        message:
          type: string
          description: Message to send
        model:
          type: string
          description: LLM model to use (optional override)
        stream:
          type: boolean
          default: false
          description: Enable SSE streaming
      required:
        - message

    PromptResponse:
      type: object
      properties:
        node_id:
          type: string
          format: uuid
          description: ID of the assistant's response node
        content:
          type: string
          description: Response content
        tokens_in:
          type: integer
        tokens_out:
          type: integer

    SSEStream:
      type: string
      description: |
        Server-Sent Events stream. Events:

        ```
        event: start
        data: {}

        event: delta
        data: {"content": "..."}

        event: done
        data: {"node_id": "..."}

        event: error
        data: error message
        ```

    Workflow:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        version:
          type: integer
        description:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - version
        - created_at
        - updated_at

    CreateWorkflowRequest:
      type: object
      properties:
        name:
          type: string
          description: Workflow name (must be unique)
        description:
          type: string
        defaults:
          $ref: '#/components/schemas/WorkflowDefaults'
        tools:
          type: array
          items:
            $ref: '#/components/schemas/ToolDefinition'
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowNode'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowEdge'
      required:
        - name
        - nodes

    WorkflowDefaults:
      type: object
      properties:
        provider:
          type: string
        model:
          type: string
        max_tokens:
          type: integer
        temperature:
          type: number

    ToolDefinition:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        input_schema:
          type: object
      required:
        - name
        - description
        - input_schema

    WorkflowNode:
      type: object
      properties:
        id:
          type: string
          description: Node ID (unique within workflow)
        type:
          type: string
          enum: [llm, tool, branch, merge, input, output]
        content:
          type: object
        model:
          type: string
        system:
          type: string
        prompt:
          type: string
        tools:
          type: array
          items:
            type: string
        handler:
          type: string
        condition:
          type: string
      required:
        - id
        - type

    WorkflowEdge:
      type: object
      properties:
        from:
          type: string
          description: Source node ID
        to:
          type: string
          description: Target node ID
        condition:
          type: string
        transform:
          type: string
      required:
        - from
        - to

    RunWorkflowRequest:
      type: object
      properties:
        input:
          type: object
          additionalProperties: true
          description: Input data for the workflow
        stream:
          type: boolean
          default: false
          description: Enable SSE streaming

    RunWorkflowResponse:
      type: object
      properties:
        dag_id:
          type: string
          format: uuid
          description: ID of the created root node
        status:
          type: string
          enum: [pending, running, completed, failed]
        output:
          type: object
          additionalProperties: true
          description: Workflow output (if completed)

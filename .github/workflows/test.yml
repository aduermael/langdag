name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build LangDAG server
        run: go build -o bin/langdag ./cmd/langdag

      - name: Install Python SDK
        working-directory: sdks/python
        run: pip install -e ".[dev]"

      - name: Install TypeScript SDK
        working-directory: sdks/typescript
        run: npm install

      - name: Start server and run E2E tests
        run: |
          LANGDAG_PROVIDER=mock LANGDAG_STORAGE_PATH=/tmp/langdag-ci.db \
            bin/langdag serve --port 18090 --host 127.0.0.1 &
          SERVER_PID=$!

          # Wait for server
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:18090/health > /dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          export LANGDAG_E2E_URL=http://127.0.0.1:18090
          FAILED=0

          echo "--- Go SDK E2E ---"
          (cd sdks/go && go test -v -run TestE2E ./...) || FAILED=1

          echo "--- Python SDK E2E ---"
          (cd sdks/python && pytest tests/test_e2e.py -v) || FAILED=1

          echo "--- TypeScript SDK E2E ---"
          (cd sdks/typescript && npx vitest run src/e2e.test.ts) || FAILED=1

          kill $SERVER_PID 2>/dev/null || true
          exit $FAILED
